{"version":3,"file":"send_email.js","sources":["send_email.js"],"sourcesContent":["/**\r\n * Handles form submission, validates input, and sends data to the server using AJAX.\r\n *\r\n * @param {Event} event - The submit event triggered by the form.\r\n * @param {string} token - The reCAPTCHA token obtained after user interaction.\r\n * @returns {void}\r\n */\r\nimport displayNotification from './modules/notification.js';\r\nimport phoneFormatter from './modules/phone_format.js';\r\nimport initButtonAnimation from './modules/button-animation.js';\r\n\r\nconst form = document.getElementById(\"my-form\");\r\n\r\n// Pobierz token z generate-token.php\r\nfetch('/php/generate-token.php')\r\n  .then(response => response.text())\r\n  .then(csrfToken => {\r\n    // Zapisz token w lokalnym storage\r\n    localStorage.setItem('csrf_token', csrfToken);\r\n\r\n    // Dodaj token do formularza\r\n    const csrfInput = document.createElement('input');\r\n    csrfInput.type = 'hidden';\r\n    csrfInput.name = 'csrf_token';\r\n    csrfInput.value = csrfToken;\r\n    form.appendChild(csrfInput);\r\n\r\n  })\r\n  .catch(error => {\r\n    const errorData = {\r\n      message: 'Błąd pobierania tokena',\r\n      url: '/php/generate-token.php',\r\n      method: 'GET',\r\n    };\r\n    Sentry.captureException(new Error(errorData.message), {\r\n      extra: errorData,\r\n    });\r\n    console.error('Błąd pobierania tokena:', error)\r\n  });\r\n\r\n/**\r\n * @description Processes a form submission, validating user input and sending it to\r\n * a PHP script via an AJAX request. It also displays notifications, resets the form\r\n * after success, and re-enables the submit button upon completion or failure.\r\n *\r\n * @param {Event} event - Used to prevent default form submission behavior.\r\n *\r\n * @param {string} token - Used to authenticate reCAPTCHA responses.\r\n */\r\nasync function handleSubmit(event, token) {\r\n  event.preventDefault();\r\n  // Check if form exists before continuing\r\n  if (!form) {\r\n    console.error(\"Form not found.\");\r\n    Sentry.captureException(error, {\r\n      extra: {\r\n        url: window.location.href,\r\n        referrer: document.referrer,\r\n        userAgent: navigator.userAgent,\r\n        formData: file,\r\n      },\r\n    });\r\n    return;\r\n  }\r\n\r\n  phoneFormatter();\r\n  \r\n  // Get form data\r\n  const formData = {\r\n    email: document.getElementById(\"email\").value,\r\n    phone: document.getElementById(\"phone\").value.replace(/\\D/g, ''),\r\n    name: document.getElementById(\"name\").value,\r\n    message: document.getElementById(\"message\").value\r\n  };\r\n\r\n  if (!validateFormData(formData)) {\r\n    return;\r\n  }\r\n\r\n  const submitButton = form.querySelector('button[type=\"submit\"]');\r\n  if (submitButton) {\r\n      submitButton.disabled = true;\r\n  }\r\n\r\n  const uniqueID = `${Date.now()}${Math.floor(Math.random() * 1000000).toString(36)}`;\r\n\r\n  const csrfToken = localStorage.getItem('csrf_token');\r\n\r\n  // Prepare data for sending\r\n  const data = new FormData();\r\n  data.append('name', formData.name);\r\n  data.append('email', formData.email);\r\n  data.append('phone', formData.phone);\r\n  data.append('message', formData.message);\r\n  data.append('g-recaptcha-response', token);\r\n  data.append('uniqueID', uniqueID);\r\n  data.append('csrf_token', csrfToken);\r\n\r\n  const file = new File([JSON.stringify(formData)], 'form_data.txt', {\r\n    type: 'text/plain',\r\n  });\r\n\r\n  await sendDataToServer(submitButton, data, file);\r\n}\r\n\r\nform.addEventListener(\"submit\", (event) => {\r\n  // Handles form submission events.\r\n  event.preventDefault();\r\n  grecaptcha.ready(() => {\r\n      // Executes reCAPTCHA and handles its response.\r\n      grecaptcha.execute('6LeTFCAqAAAAAKlvDJZjZnVCdtD76hc3YZiIUs_Q', {action: 'submit'})\r\n      .then((token) => {\r\n          // Handles ReCAPTCHA responses.\r\n          if (token) {\r\n              handleSubmit(event, token);\r\n          } else {\r\n              displayNotification(\"ReCAPTCHA verification failed. Please try again.\", 'error');\r\n          }\r\n      })\r\n      .catch((error) => {\r\n          // Catches ReCAPTCHA errors.\r\n          console.error(\"ReCAPTCHA error:\", error);\r\n          displayNotification(\"ReCAPTCHA verification failed. Please try again.\", 'error');\r\n      });\r\n  });\r\n})\r\n\r\n/**\r\n * Validates form data before sending it to the server.\r\n *\r\n * @param {Object} formData - Object containing form data.\r\n *\r\n * @returns {boolean} - Returns true if form data is valid, false otherwise.\r\n */\r\n\r\nfunction validateFormData(formData) {\r\n  const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/;\r\n  const mobilePhonePattern = /^[0-9]{9}$/; // Polish mobile phone pattern: 9 digits\r\n\r\n  if (!formData.email && !formData.phone) {\r\n    displayNotification(\"Proszę podać adres email lub numer telefonu.\", 'error');\r\n    return false;\r\n  }\r\n\r\n  if (formData.email && !emailPattern.test(formData.email)) {\r\n    displayNotification(\"Proszę podać prawidłowy adres email.\", 'error');\r\n    return false;\r\n  }\r\n\r\n  if (formData.phone && !mobilePhonePattern.test(formData.phone)) {\r\n    displayNotification(\"Proszę podać prawidłowy numer telefonu (9 cyfr).\", 'error');\r\n    return false;\r\n  }\r\n  return true;\r\n}\r\n\r\n/**\r\n * @description Sends form data to a PHP script using the Fetch API. It processes\r\n * the response, displaying notifications based on the result. It also resets the\r\n * form after success, re-enables the submit button upon completion, and handles\r\n * errors gracefully.\r\n *\r\n * @param {HTMLElement} submitButton - The form's submit button element.\r\n * @param {FormData} data - An object containing form data to be sent to the server.\r\n * @returns {Promise<void>}\r\n */\r\nasync function sendDataToServer(submitButton, data, file) {\r\n\r\n  const { animateButton, resetButton } = initButtonAnimation();\r\n\r\n  try {\r\n    const response = await fetch('../php/send_email.php', {\r\n      method: 'POST',\r\n      body: data,\r\n    });\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`Błąd ${response.status}: ${response.statusText}`);\r\n    }\r\n\r\n    const result = await response.json();\r\n  \r\n    if (result.success) {\r\n      displayNotification(result.message, 'success');\r\n      setTimeout(() => {\r\n        // Calls animateButton with 'success'.\r\n        animateButton('success');\r\n      }, 0);\r\n      setTimeout(() => {\r\n        // Calls form.reset() with a delay.\r\n        form.reset(); // Reset the form after success\r\n      }, 5000); // Delaying reset after success message\r\n    } else {\r\n      displayNotification(result.message, 'error');\r\n      setTimeout(() => {\r\n        // Immediately invokes itself.\r\n        animateButton('error');\r\n      }, 0);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Form submission error:\", error.message, error.stack);\r\n    handleError(file, error);\r\n  } finally {\r\n    // Re-enable the submit button\r\n    submitButton.disabled = false;\r\n    setTimeout(() => {\r\n      // Calls `resetButton` after 5 seconds delay.\r\n      resetButton ();\r\n    }, 5000);\r\n  }\r\n}\r\n\r\n/**\r\n * Captures and handles errors by reporting them to Sentry and notifying the user.\r\n *\r\n * This function utilizes Sentry's `captureException` to log the provided error along with \r\n * additional context, such as form data and specific tags. It also displays a user-friendly \r\n * error message to inform the user of the encountered issue.\r\n *\r\n * @param {Error} error - The error object to be captured and reported.\r\n * @param {Object} data - The form data associated with the error (should be defined in the scope).\r\n * @param {Object} [options] - Optional parameters for additional context.\r\n * @param {string} options.formName - The name of the form where the error occurred, used for tagging.\r\n * \r\n * @tags {Object} tags - Tags to categorize the error.\r\n * @tags.form-name {string} 'kontakt' - The name of the form that triggered the error, aiding in filtering and analysis.\r\n */\r\nfunction handleError(file, error) {\r\n  Sentry.captureException(error, {\r\n    attachments: [\r\n      {\r\n        filename: 'form_data.txt',\r\n        data: file,\r\n        contentType: 'text/plain',\r\n      },\r\n    ],  \r\n    tags: {\r\n      'form-name': 'kontakt',\r\n    },\r\n    extra: {\r\n      url: window.location.href,\r\n      referrer: document.referrer,\r\n      userAgent: navigator.userAgent,\r\n      formData: file,\r\n    },\r\n  });\r\n if (error.message.includes('Błąd')) {\r\n    displayNotification('Wystąpił błąd. Proszę spróbować ponownie.', 'error');\r\n  } else {\r\n    displayNotification('Wystąpił nieoczekiwany błąd. Proszę skontaktować się z administratorem.', 'error');\r\n  }\r\n}\r\n\r\nexport { handleSubmit, validateFormData, sendDataToServer, handleError };"],"names":["displayNotification","phoneFormatter","initButtonAnimation","form","document","getElementById","async","handleSubmit","event","token","preventDefault","console","error","Sentry","captureException","extra","url","window","location","href","referrer","userAgent","navigator","formData","file","email","value","phone","replace","name","message","validateFormData","submitButton","querySelector","uniqueID","disabled","Date","now","Math","floor","random","toString","csrfToken","localStorage","getItem","data","FormData","append","File","JSON","stringify","type","await","sendDataToServer","test","mobilePhonePattern","animateButton","resetButton","response","fetch","method","body","ok","Error","status","statusText","result","json","success","setTimeout","reset","stack","handleError","attachments","filename","contentType","tags","form-name","includes","then","text","setItem","csrfInput","createElement","appendChild","catch","errorData","addEventListener","grecaptcha","ready","execute","action"],"mappings":"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"}