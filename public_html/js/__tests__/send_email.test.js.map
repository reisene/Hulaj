{"version":3,"file":"send_email.test.js","sources":["__tests__/send_email.test.js"],"sourcesContent":["import { jest } from \"@jest/globals\";\nimport displayNotification from \"../modules/notification\";\nimport phoneFormatter from \"../modules/phone-format\";\nimport initButtonAnimation from \"../modules/button-animation\";\n\n// Mock dependencies\njest.mock(\"../modules/notification\");\njest.mock(\"../modules/phone-format\");\njest.mock(\"../modules/button-animation\");\n\ndescribe(\"Form Submission Handler\", () => {\n  let mockForm;\n  let mockSubmitButton;\n\n  beforeEach(() => {\n    // Setup DOM elements\n    mockForm = document.createElement(\"form\");\n    mockForm.id = \"my-form\";\n\n    mockSubmitButton = document.createElement(\"button\");\n    mockSubmitButton.type = \"submit\";\n    mockForm.appendChild(mockSubmitButton);\n\n    // Add form inputs\n    const inputs = [\"email\", \"phone\", \"name\", \"message\", \"csrf-token\"];\n    inputs.forEach((id) => {\n      const input = document.createElement(\"input\");\n      input.id = id;\n      input.value = `test-${id}`;\n      mockForm.appendChild(input);\n    });\n\n    document.body.appendChild(mockForm);\n\n    // Mock fetch\n    global.fetch = jest.fn();\n    global.localStorage = {\n      getItem: jest.fn(),\n      setItem: jest.fn(),\n    };\n  });\n\n  afterEach(() => {\n    document.body.innerHTML = \"\";\n    jest.clearAllMocks();\n  });\n\n  test(\"generateCsfrToken fetches and stores token correctly\", async () => {\n    const mockToken = \"test-token\";\n    global.fetch.mockResolvedValueOnce({\n      text: () => Promise.resolve(mockToken),\n    });\n\n    await generateCsfrToken();\n\n    expect(global.fetch).toHaveBeenCalledWith(\"/php/generate-token.php\");\n    expect(localStorage.setItem).toHaveBeenCalledWith(\"csrf_token\", mockToken);\n    expect(document.getElementById(\"csrf-token\").value).toBe(mockToken);\n  });\n\n  test(\"validateFormData handles validation success\", async () => {\n    const formData = {\n      email: \"test@example.com\",\n      phone: \"123456789\",\n      name: \"Test User\",\n      message: \"Test message\",\n    };\n\n    global.fetch.mockResolvedValueOnce({\n      json: () => Promise.resolve({ success: true }),\n    });\n\n    const result = await validateFormData(mockSubmitButton, formData);\n    expect(result).toBe(true);\n  });\n\n  test(\"validateFormData handles validation error\", async () => {\n    const formData = {\n      email: \"invalid-email\",\n      phone: \"\",\n      name: \"\",\n      message: \"\",\n    };\n\n    global.fetch.mockResolvedValueOnce({\n      json: () => Promise.resolve({ error: \"Validation failed\" }),\n    });\n\n    await expect(validateFormData(mockSubmitButton, formData)).rejects.toThrow(\n      \"Validation failed\",\n    );\n    expect(displayNotification).toHaveBeenCalledWith(\n      \"Validation failed\",\n      \"error\",\n    );\n  });\n\n  test(\"sendDataToServer handles successful submission\", async () => {\n    const mockData = new FormData();\n    const mockFile = new File([\"{}\"], \"test.txt\");\n\n    global.fetch.mockResolvedValueOnce({\n      ok: true,\n      json: () => Promise.resolve({ success: true, message: \"Success\" }),\n    });\n\n    await sendDataToServer(mockSubmitButton, mockData, mockFile);\n\n    expect(displayNotification).toHaveBeenCalledWith(\"Success\", \"success\");\n    expect(mockSubmitButton.disabled).toBe(false);\n  });\n\n  test(\"sendDataToServer handles submission error\", async () => {\n    const mockData = new FormData();\n    const mockFile = new File([\"{}\"], \"test.txt\");\n\n    global.fetch.mockRejectedValueOnce(new Error(\"Network error\"));\n\n    await sendDataToServer(mockSubmitButton, mockData, mockFile);\n\n    expect(displayNotification).toHaveBeenCalledWith(\n      \"Wystąpił nieoczekiwany błąd. Proszę skontaktować się z administratorem.\",\n      \"error\",\n    );\n    expect(mockSubmitButton.disabled).toBe(false);\n  });\n\n  describe(\"getFormData\", () => {\n    test(\"returns correctly formatted form data\", () => {\n      const formData = getFormData();\n      expect(formData).toEqual({\n        email: \"test-email\",\n        phone: \"test-phone\",\n        name: \"test-name\",\n        message: \"test-message\",\n      });\n    });\n\n    test(\"strips non-digits from phone number\", () => {\n      document.getElementById(\"phone\").value = \"+1 (234) 567-8900\";\n      const formData = getFormData();\n      expect(formData.phone).toBe(\"12345678900\");\n    });\n  });\n\n  describe(\"prepareData\", () => {\n    test(\"creates FormData with all required fields\", () => {\n      const formData = {\n        email: \"test@example.com\",\n        phone: \"123456789\",\n        name: \"Test User\",\n        message: \"Test message\",\n      };\n      const token = \"test-token\";\n\n      const result = prepareData(formData, token);\n\n      expect(result instanceof FormData).toBe(true);\n      expect(result.get(\"email\")).toBe(formData.email);\n      expect(result.get(\"phone\")).toBe(formData.phone);\n      expect(result.get(\"name\")).toBe(formData.name);\n      expect(result.get(\"message\")).toBe(formData.message);\n      expect(result.get(\"g-recaptcha-response\")).toBe(token);\n      expect(result.get(\"csrf_token\")).toBeDefined();\n      expect(result.get(\"uniqueID\")).toBeDefined();\n    });\n  });\n\n  describe(\"handleError\", () => {\n    beforeEach(() => {\n      global.Sentry = {\n        captureException: jest.fn(),\n      };\n    });\n\n    test(\"captures exception with correct data\", () => {\n      const mockFile = new File([\"{}\"], \"test.txt\");\n      const mockError = new Error(\"Test error\");\n\n      handleError(mockFile, mockError);\n\n      expect(Sentry.captureException).toHaveBeenCalledWith(\n        mockError,\n        expect.objectContaining({\n          tags: { \"form-name\": \"kontakt\" },\n          attachments: expect.arrayContaining([\n            expect.objectContaining({\n              filename: \"form_data.txt\",\n              contentType: \"text/plain\",\n            }),\n          ]),\n        }),\n      );\n    });\n\n    test(\"displays correct error message for known errors\", () => {\n      const mockFile = new File([\"{}\"], \"test.txt\");\n      const mockError = new Error(\"Błąd 404\");\n\n      handleError(mockFile, mockError);\n\n      expect(displayNotification).toHaveBeenCalledWith(\n        \"Wystąpił błąd. Proszę spróbować ponownie.\",\n        \"error\",\n      );\n    });\n\n    test(\"displays generic error message for unknown errors\", () => {\n      const mockFile = new File([\"{}\"], \"test.txt\");\n      const mockError = new Error(\"Unknown error\");\n\n      handleError(mockFile, mockError);\n\n      expect(displayNotification).toHaveBeenCalledWith(\n        \"Wystąpił nieoczekiwany błąd. Proszę skontaktować się z administratorem.\",\n        \"error\",\n      );\n    });\n  });\n});\n"],"names":["jest","displayNotification","phoneFormatter","initButtonAnimation","mock","describe","let","mockForm","mockSubmitButton","beforeEach","document","createElement","id","type","appendChild","forEach","input","value","body","global","fetch","fn","localStorage","getItem","setItem","afterEach","innerHTML","clearAllMocks","test","async","mockToken","mockResolvedValueOnce","text","Promise","resolve","await","generateCsfrToken","expect","toHaveBeenCalledWith","getElementById","toBe","json","success","result","validateFormData","email","phone","name","message","error","rejects","toThrow","mockData","FormData","mockFile","File","ok","sendDataToServer","disabled","mockRejectedValueOnce","Error","formData","getFormData","toEqual","token","prepareData","get","toBeDefined","Sentry","captureException","mockError","handleError","objectContaining","tags","form-name","attachments","arrayContaining","filename","contentType"],"mappings":"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"}